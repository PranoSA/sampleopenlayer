(()=>{let e=new ol.source.Vector({url:"http://localhost:3000/api/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=ne:Power_Plants&outputFormat=application/json",format:new ol.format.GeoJSON});var t=document.getElementById("popup"),o=document.getElementById("popup-content"),n=document.getElementById("popup-closer"),r=new ol.Overlay({element:t,autoPan:!0,autoPanAnimation:{duration:250}});n.onclick=function(){return r.setPosition(void 0),n.blur(),!1};let l=new ol.layer.Vector({source:new ol.source.Vector({url:"http://localhost:3000/api/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=ne:Electric_Power_Transmission_Lines_A&outputFormat=application/json&CQL_FILTER=VOLTAGE>700",format:new ol.format.GeoJSON})});var i=new ol.style.Style({stroke:new ol.style.Stroke({color:"#ff00ff",width:4})});const a=new ol.style.Style({stroke:new ol.style.Stroke({color:"#00ffff",width:4})});l.setStyle(i),new ol.layer.Heatmap({source:e,blur:15,radius:5});var s=new ol.source.Cluster({distance:50,source:e}),c=new ol.layer.Vector({source:s,style:function(e){var t=e.get("features").reduce((function(e,t){return e+(t.get("Total_MW")||0)}),0);let o=m.getView().getZoom();console.log("Zoom: "+o);var n=10;return o>10&&(n=Math.min(30,10+t/10)),o>5&&o<10&&(n=Math.min(30,10+t/1e3)),o<5&&(n=Math.min(20,5+t/1e4)),console.log("Size: "+n),new ol.style.Style({image:new ol.style.Circle({radius:n,stroke:new ol.style.Stroke({color:"#fff"}),fill:new ol.style.Fill({color:"#3399CC"})}),text:new ol.style.Text({text:t>1e6?Math.round(t/1e6).toString()+"TW":t>1e3?Math.round(t/1e3).toString()+"GW":Math.round(t).toString()+"MW",fill:new ol.style.Fill({color:"#000"})})})}});let u=l;var m=new ol.Map({target:"map",layers:[new ol.layer.Tile({source:new ol.source.OSM}),c,l],view:new ol.View({center:ol.proj.fromLonLat([-98.5795,39.8283],"EPSG:3857"),zoom:4,projection:"EPSG:3857"})});m.addOverlay(r);let g=15;m.getView().on("change:resolution",(function(){var e=m.getView().getZoom();if(console.log("zoom level: "+e),e<8&&g>8)filter="VOLTAGE>700";else if(e>=8&&e<12&&(g<8||g>=12))filter="VOLTAGE>200";else{if(!(e>=12&&g<12))return;filter="INCLUDE"}g=e;var t=m.getView().calculateExtent(m.getSize()),o=m.getView().getProjection(),n=`BBOX(the_geom,${ol.proj.transformExtent(t,o,"EPSG:3857").join(",")})`,r=`${filter} AND ${n}`,a=`http://localhost:3000/api/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=ne:Electric_Power_Transmission_Lines_A&outputFormat=application/json&CQL_FILTER=${encodeURIComponent(r)}`;console.log("wfsUrl "+a);var s=f?f.getId():null;m.removeLayer(u);var c=new ol.layer.Vector({source:new ol.source.Vector({format:new ol.format.GeoJSON,url:a})});if(u=c,f&&c.getSource().addFeature(f),f.setStyle(d),m.addLayer(c),s){var f=c.getSource().getFeatureById(s);f&&f.setStyle(d)}l.setStyle(i),f&&f.setStyle(d)})),document.getElementById("min-voltage").addEventListener("input",(function(){let e=this.value;document.getElementById("voltage-value").textContent=e;let t=0,o=0;setTimeout((()=>{t==e&&o==document.getElementById("min-distance").value||(t=e,o=document.getElementById("min-distance").value)}),2e3)})),document.getElementById("min-distance").addEventListener("input",(function(){let e=this.value;document.getElementById("distance-value").textContent=e})),document.getElementById("update-map-btn").addEventListener("click",(function(){const e=document.getElementById("min-voltage").value,t=document.getElementById("min-distance").value;console.log("Updating Map"),function(e,t){if(0==t&&0==e)return;let o=`VOLTAGE>${e} AND SHAPE__Len>${t}`;var n=m.getView().calculateExtent(m.getSize()),r=m.getView().getProjection(),l=`BBOX(the_geom,${ol.proj.transformExtent(n,r,"EPSG:3857").join(",")})`,a=`http://localhost:3000/api/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=ne:Electric_Power_Transmission_Lines_A&outputFormat=application/json&CQL_FILTER=${encodeURIComponent(`${o} AND ${l}`)}`;console.log("wfsUrl "+a),m.removeLayer(u);var s=new ol.layer.Vector({source:new ol.source.Vector({format:new ol.format.GeoJSON,url:a})});u=s,s.setStyle(i),m.addLayer(s),s.getSource().addFeature(f),f.setStyle(d)}(e,t)}));var d=new ol.style.Style({stroke:new ol.style.Stroke({color:"#ff0000",width:5})}),f=null;m.on("singleclick",(function(e){f&&f.setStyle(null),m.forEachFeatureAtPixel(e.pixel,(function(t,n){if(n===u){var l=t.getProperties(),i=`Name: ${l.OWNER}<br>\n                Length: ${Math.round(l.SHAPE__Len/1e3)} km <br> \n                Voltage: ${l.VOLTAGE}<br>\n                Substation 1: ${l.SUB_1}<br>\n                Substation 2: ${l.SUB_2}`;o.innerHTML=i;var a=e.coordinate;return r.setPosition(a),f&&f.setStyle(null),f=t,t.setStyle(d),f=t,console.log(t),t}}),{layerFilter:function(e){return e===u}})}));var p,y,v=!1;(t=document.getElementById("popup")).addEventListener("mousedown",(function(e){if(t.contains(e.target)){v=!0;var o=t.getBoundingClientRect();p=e.clientX-parseFloat(o.left),y=e.clientY-parseFloat(o.top),t.style.cursor="grabbing",e.preventDefault()}})),document.addEventListener("mousemove",(function(e){if(v){var o=e.clientX-p,n=e.clientY-y;t.style.left=o-650+"px",t.style.top=n-40+"px"}})),document.addEventListener("mouseup",(function(){v=!1,t.style.cursor="grab"})),t.addEventListener("selectstart",(function(e){e.preventDefault()})),m.on("singleclick",(function(e){var t=document.getElementById("info"),o=!1;m.forEachFeatureAtPixel(e.pixel,(function(e,n){var r="Power Plant Name: "+e.getProperties().Plant_Name;t.innerHTML=r,o=!0})),m.on("moveend",(function(){m.getView().getZoom()>10?s.setDistance(0):s.setDistance(40)})),o||(t.innerHTML="Click on a point")})),m.on("pointermove",(function(e){if(e.dragging)return;const t=m.getEventPixel(e.originalEvent),o=m.hasFeatureAtPixel(t);m.getTargetElement().style.cursor=o?"pointer":""}));let w=null;m.on("pointermove",(function(e){if(e.dragging)return;const t=m.getEventPixel(e.originalEvent),o=m.forEachFeatureAtPixel(t,(function(e){return e}));w&&o!==w&&w!==f&&(w.setStyle(null),w=null),o&&!w?(o.setStyle(a),w=o,m.getTargetElement().style.cursor="pointer"):m.getTargetElement().style.cursor=""}))})();